/*! Web Resource Loader - v0.1.0 - 2013-05-30
* Copyright (c) 2013 Francesco DalprÃ ; Licensed MIT */
(function(e){function t(){function t(t,n){if(typeof n=="undefined")return e[t];if(typeof n=="string")return e[t][n];if(typeof n=="object"&&typeof n.length=="number"){var r={};for(var i in n)r[n[i]]=e[t][n[i]];return r}}function r(e,n,i){var s=t(e,n.name),o=s.require(),u=[];for(var a in o)var f=/^([\w|\W]+):([\w|\W]+)$/.exec(o[a]),l=f?u.push({name:f[1],meth:f[2]}):u.push({name:o[a],meth:null});var c;if(u){for(var h in u)r(e,u[h],i);c=s.isVirtual()||i.push({meth:n.meth,res:s.pointer()})}else c=s.isVirtual()||i.push({meth:n.meth,res:s.pointer()})}function i(e,t){var n=[];return r(e,{name:t,meth:null},n),n}function s(e,t){var n=i(e,t),r={ready:!1,tot:n.length,readyRef:[],resurces:[],nrr:0,loadPerc:function(){return(this.nrr*100/this.tot).toFixed(2)}};for(var s in n){var o=n[s];o.res().ready()?(r.nrr++,r.readyRef.push(o.res().name())):r.resurces.push(o.res().name())}return r.ready=r.tot===r.nrr,r}function o(t,n,r){return e[t][n].isLoaded(r)}function u(t,n,r){return e[t][n].isLoading(r)}var e={};this.jsLoaded=function(e,t){return o("js",e,t)},this.jsLoading=function(e,t){return u("js",e,t)},this.getJsReq=function(e){return i("js",e)},this.getCssReq=function(e){return i("css",e)},this.getGetReq=function(e){return i("get",e)},this.jsReady=function(e){return s("js",e)},this.cssReady=function(e){return s("css",e)},this.getReady=function(e){return s("get",e)},this.load=function(t){for(var r in{js:!0,css:!0,get:!0}){e[r]={};for(var i in t[r])e[r][i]=new n(i,r,t[r][i])}},this.plugLoad=function(e){n.prototype.pluggedLoad=e},this.plugLoadJS=function(e){n.prototype.pluggedLoadJS=e},this.plugLoadCSS=function(e){n.prototype.pluggedLoadCSS=e},this.plugLoadGET=function(e){n.prototype.pluggedLoadGET=e}}function n(e,t,n){this.pointer=function(){var e=this;return function(){return e}},this.isLoaded=function(e){return typeof e!="undefined"?(r.loaded=e,r.loaded):r.loaded},this.isLoading=function(e){return typeof e!="undefined"?(r.loading=e,r.loaded):r.loading},this.ready=function(){return r.loaded&&!r.loading?!0:!1},this.load=function(e){var t=null;!r.loaded&&!r.loading?(r.loading=!0,r.statinfo="resource in loading",r.statcode=1,t=r.type==="js"&&this.pluggedLoadJS(this.resLoadHandler,r,e),t=r.type==="css"&&this.pluggedLoadCSS(this.resLoadHandler,r,e),t=r.type==="get"&&this.pluggedLoadGET(this.resLoadHandler,r,e)):t=typeof e=="function"&&e(r)},this.resLoadHandler=function(e,t){e.loading=!1,e.loaded=!0,e.statinfo="resource is loaded",e.statcode=2;var n=typeof t=="function"&&t(e)},this.data=function(e){return typeof e!="undefined"&&(r.data=e),r.data},this.url=function(){return r.url},this.require=function(){return r.require},this.name=function(){return r.name},this.isVirtual=function(){return r.virtual},this.attach=function(){return r.attach},this.statinfo=function(){return r.statinfo},this.statcode=function(){return r.statcode};var r={};r.virtual=typeof n.url=="undefined"&&!0||!1,r.name=e,r.type=t,r.id=n.id||null,r.require=n.require||null,r.url=n.url,r.defer=n.defer||!1,r.loaded=!1,r.loading=!1,r.media=n.media||null,r.attach=n.attach||"first",r.data=null,r.statinfo="resourse not loaded",r.statcode=0}function r(e){function n(e,t,n,r){var i=!1;return function(){this.readyState?!i&&(this.readyState==="complete"||this.readyState==="loaded")&&(t(n,r),i=!0,e.onreadystatechange=null):(t(n,r),e.onload=null)}}function i(e,t,r){var i=document.createElement("script");i.setAttribute("type","text/javascript"),i.setAttribute("charset","utf-8"),i.setAttribute("src",t.url);var s=t.id&&i.setAttribute("id",t.id);s=t.defer&&i.setAttribute("defer",t.defer),i.onreadystatechange=i.onload=n(i,e,t,r);var o=document.getElementsByTagName("head")[0],u;o?o.firstChild?(u=o,o=o.firstChild,u.insertBefore(i,o)):o.appendChild(i):(o=document.getElementsByTagName("script")[0],u=o.parentNode,u.insertBefore(i,o))}function s(e,t,r){var i=document.createElement("link");i.setAttribute("type","text/css"),i.setAttribute("rel","stylesheet"),i.setAttribute("href",t.url),i.onreadystatechange=i.onload=n(i,e,t,r);var s=document.getElementsByTagName("head")[0],o;s&&(t.attach==="first"&&(s.firstChild?(o=s,s=s.firstChild,o.insertBefore(i,s)):s.appendChild(i)),t.attach==="last"&&s.appendChild(i))}function o(e,t,n){console.log("you must implement GET resource loader ....")}function u(){var e=!1;return function(t){return typeof t!="undefined"&&(e=t),e}}function a(e){return function(){return e--}}function f(e){var t=this.opt.events.notifyStatus&&this.config[e.type+"Ready"](e.name),n;this.opt.events.type==="onload"&&(n=e.type+"-"+"loaded"),this.opt.events.type==="byname"&&(n=e.type+"-"+e.name),this.opt.events.type==="all"&&this.trigger(e.type+"-"+"loaded",{res:e,status:t}),this.trigger(n,{res:e,status:t})}function l(e,t,n,r,i){var s=this;return function(){t[e].res().load(function(e){i.push(e),s.opt.events&&setTimeout(function(){f.call(s,e)},0),n()||r(!0)})}}function c(e,t,n,r,i,s){var o=this;return function(){t[e].res().load(function(t){s.push(t),o.opt.events&&setTimeout(function(){f.call(o,t)},0),n()||r(!0),i[e+1]()})}}function h(e,t,n,r,i,s){var o=this;return function(){t[e].res().load(function(e){s.push(e),o.opt.events&&setTimeout(function(){f.call(o,e)},0),n()||r(!0)}),i[e+1]()}}function p(e,t){function s(e,t,r,i,s,o){return e===t.length-1?l.call(n,e,t,s,o,i):t[e].meth==="wait"?c.call(n,e,t,s,o,r,i):h.call(n,e,t,s,o,r,i)}var n=this,r=u(),i=a(e.length-1),o=[],f=function(){return function(){var t=[];for(var u=e.length-1;u>=0;u--)t.unshift(s.call(n,u,e,t,o,i,r));t[0]()}}(e),p=e.length&&setTimeout(f,1),d=setInterval(function(){if(r()){var e=typeof t=="function"&&t(o);clearInterval(d)}},1)}if(typeof e.opt!="undefined"){var d={type:"byname",notifyStatus:!1};if(!e.opt.events)e.opt.events={type:"byname",notifyStatus:!1};else for(var v in d)e.opt.events[v]=typeof e.opt.events[v]!="undefined"&&e.opt.events[v]||d[v]}else e.opt={events:!1};var m={opt:e.opt,name:e.name,config:new t,loadJS:function(e,t){p.call(this,this.config.getJsReq(e),t)},loadCSS:function(e,t){p.call(this,this.config.getCssReq(e),t)},loadGET:function(e,t){p.call(this,this.config.getGetReq(e),t)},trigger:function(e,t){console.log("fire trigger ...",e,t)},bind:function(){}};return m.fnLoadJS=r.prototype.fnLoadJS,m.fnLoadCSS=r.prototype.fnLoadCSS,m.fnLoadGET=r.prototype.fnLoadGET,m.config.plugLoadJS(m.fnLoadJS),m.config.plugLoadCSS(m.fnLoadCSS),m.config.plugLoadGET(m.fnLoadGET),m.config.load(e.config),r.prototype._loadfnJS=i,r.prototype._loadfnCSS=s,r.prototype._loadfnGET=o,m}n.prototype.pluggedLoadJS=function(e,t,n){e(t,n)},n.prototype.pluggedLoadCSS=function(e,t,n){e(t,n)},n.prototype.pluggedLoadGET=function(e,t,n){e(t,n)},r.prototype.fnLoadJS=function(e,t,n){r.prototype._loadfnJS(e,t,n)},r.prototype.fnLoadCSS=function(e,t,n){r.prototype._loadfnCSS(e,t,n)},r.prototype.fnLoadGET=function(e,t,n){r.prototype._loadfnGET(e,t,n)},e.extend({wrl:{loaders:{},addLoader:function(t,n){function o(t){var n=e(new r(t));return n[0].trigger=e.proxy(n.trigger,n),n[0].bind=e.proxy(n.bind,n),n.loadJS=e.proxy(n[0].loadJS,n[0]),n.loadCSS=e.proxy(n[0].loadCSS,n[0]),n.loadGET=e.proxy(n[0].loadGET,n[0]),n}var i=this,s;r.prototype.fnLoadGET=this.fnLoadGET;if(e.type(t.config)!="string")return s=o(t),this.loaders[t.name]=s,s;e.getJSON(t.config,function(r){t.config=r;var s=o(t);i.loaders[t.name]=s,e.type(n)=="function"&&n(s)}).error(function(e,t,n){console.log("Get config in error [",t,"]")})},loadJS:function(e,t,n){return this.loaders[e].loadJS(t)},loadCSS:function(e,t){return this.loaders[e].loadCSS(t),this.loaders[e]},loadGET:function(e,t){return this.loaders[e].loadGET(t),this.loaders[e]},fnLoadGET:function(t,n,r){e.get(n.url,function(e){n.data=e,t(n,r)})}}})})(jQuery);